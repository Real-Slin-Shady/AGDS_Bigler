---
title: "Report_Exercise_2"
author: "Patrick Bigler"
date: "2023-04-10"
output: html_document
editor_options: 
  markdown: 
    wrap: 75
---

## Report Exercises 2

### Introduction

The following code chunk contains all packages we need for this exercise.
If we run the chunk, we activate the packages. Important is the package
"conflicted". It enables us to chose if different functions have the same
call but do not make the same thing (a function in a certain package can
have the same name as a function from another package).

```{r activate_the_packages_which_are_required}
library(tidyverse)
library(ggplot2)
library(cowplot)
library(datasets)
library(conflicted)
library(knitr)
library(corrplot)
library(ggcorrplot)
library(ggpubr)
library(ggpmisc)
library(gridExtra)
library(gridtext)
library(grid)
library(lattice)
```

Air quality depends on factors such as particulate matter (PM10 or PM2.5),
nitrogen dioxide $(NO_2)$ or ozone $(O_3)$. In this short paper, only the
tropospheric ozone is considered for air quality. All other parameters are
neglected. In general, ozone occurs naturally in the troposphere and is not
a health hazard per se (Brönnimann 2013, 23). But a high concentration over
a longer period of time, ozone can affect the health. But what is a high
concentration and what is a longer period of time? The measured values for
ozone must therefore be compared with some reference values. Here, the
threshold value for Switzerland is used, which is $120\: \frac{\mu g}{m^3}$
(Brönnimann 2013, 23) over eight hours. However, this unit depends on the
air pressure, which decreases with altitude. The volume mixing ratio with
the unit parts per million is more suitable which is about 60 ppm
(Brönnimann 2013, 26). It should be noted that countries are basically free
to define their own threshold values (most of it doing it with the WHO). It
is therefore possible that the USA (where the original data come from)
would use a different value.

Ozone is a molecule consisting of 3 oxygen atoms and has various physical
(absorption of UV and IR radiation) and chemical properties (high
reactivity). Ozone emerges due to a 2 phase chemical reaction (Brönnimann
2013, 75):

1.  $NO_2 + h\nu \left(\lambda < 420 nm \right) \rightleftharpoons NO + O$

2.  $NO + O_3 \rightleftharpoons NO_2 + O_2$

From the reaction equations it follows that UV radiation, oxygen and
nitrogen dioxide are needed for the formation of ozone . The first two are
available in almost unlimited quantities. Thus, the production depends
mainly on nitrogen dioxide. But what are the main sources of the nitrogen
dioxide? For the planetary boundary layer (and therefore for the surface as
well), it is motorized traffic (Brönnimann 2013, 95). Lastly, many chemical
reactions are temperature dependent. This is also true for ozone. The
higher the temperature, the more the balance of the reaction shifts towards
ozone production and the concentration increases (Brönnimann 2013, 95).

In summary, the ozone concentration depends probably on temperature, solar
radiation (mostly IR-radiation) and the concentration of nitrogen dioxide
(which depends on traffic). But if strong winds blow over a highway, the
nitrogen particles are blown away and the concentration is lower than
expected. With these considerations, a data set on air-quality can be
studied with a focus on ozone.

### Hypothesis

In these small paper the following research question should be answered:

*"Quantify the dependency of ozone concentration from temperature, solar
radiation and wind"*

### Original source of the file

The data is example data frame in the R package "datasets". First, the data
frame is a secondary source an we must know about the contain, the values,
the units and, of course, the source itself. For that, R can be asked for
help to gather all these information.

```{r shows_the_data_frame_airquality}
# read the data
airquality <- datasets::airquality

# Ask for details (units, source and references)
help("airquality")

# Check weather there are missing values
is.na(airquality)
```

The data frame shows different variables at different times. Start was
05.01.1973 (a Tuesday) and ends at 09.09.1973 and each day has an entry (it
could be an "float", "integer", "character" or a "NA"). The variables are
Ozone, Solar.R., Wind, Temp, Month and Year. But not all variables has the
same source. That is why we distinguish the variable according to the
source before we describing them.

Data for ozone were collected from the New York State Department of
Conservation.

-   Ozone [ppb] represent the average of the concentration between 1pm and
    3pm at Roosevelt Island, NYC. This means that we are dealing with
    tropospheric ozone.

Data for the meteorological data were collected from the US. National
Weather Service. The data frame contains:

-   Wind [mph] is calculated as the average wind speed at 7am and 10am at
    La Guardia Airport, NYC

-   Temperature [degrees Fahrenheit] is the maximum daily temperature at la
    Guardia Airport, NYC

-   Solar. R [Langley] average in the frequency band 4000-7700 Angstroms
    (wavelength: 400-770 nano meter) from 8am to noon in Central Park NYC.

### Editing the file in SI-Units

It is strongly recommended to use the SI unit system because it is
simplifies the reproducibility and the interpretation and discussion of the
data. It follows the formulas to calculates the values from there units
into the SI-units system

-   For temperature the following formula was used:
    $$\frac{x \left[°Fahrenheit \right]- 32}{1.8} +273.15 \Longleftrightarrow x\left[Kelvin \right]$$

-   For wind speed the following formula was used :
    $$1 \left[\frac{mile}{hour} \right] \Longleftrightarrow 0.44704 \left[\frac{meter}{second}\right]$$

-   For solar radiation the following formula was used :
    $$1 \left[ Langley \right] \Longleftrightarrow 41840 \left[ \frac{Joule}{m^2}\right]$$

```{r editing_the_data_frame_in_SI_units}
# mutate columns to SI units (if necessary) and save the data frame to a variable
airquality_mutated <- airquality |>
# change values from Fahrenheit to kelvin  
  mutate(Temp = (Temp - 32) / 1.8 + 273.15) |> 
# change values from mp/h to m/s  
  mutate(Wind = Wind * 0.44704) |> 
# change values from Langley to joule per square meter  
  mutate(Solar.R = Solar.R * 41840) |>
  mutate(Date = make_date(1973, Month, Day))

# define a order for the rows
airquality_mutated$Month <- factor(airquality_mutated$Month, 
                                   levels =  c(5, 6, 7, 8, 9), 
                                   labels = c("May", "Jun", "Jul", "Aug", "Sept"))
```

### Statistics

#### Parameter for position and distribution

Now that all units have been converted to SI units and the work with the
variables is legitimate, the question about the position, scattering and
distribution parameters arises. For the ozone concentration is the median
the right position parameter because it is robust against outliers. This is
important because a short time higher concentration of ozone is probably
not a problem for the human well-being but for a long term it could be. If
we use the mean, we loss the overall picture due to a big one time outlier.

If the median has been used it should be used the IQR as a scattering
parameter. The following code calculate these parameters (Minimum, 0.25,
0.5 and 0.75 quantiles, IQR and maximum).

It shows us that the monthly median (18,23,60,52,23 ppb) is lower or equal
to the threshold value (60 ppm). Therefore, there the air-quality is
acceptable. But there are measurements in every month which exceed the
threshold value (maximum). That means that there are isolated days when the
ozone concentration is problematic. If we compare the span with the IQR we
notice that the IQR is clearly smaller than the span. With this Information
and according to the small monthly ozone average follows that we do not
have much outliers in our data. Because these parameters are difficult to
interpret it follows a box-whisker plot to visualize the distribution of
the data , inclusive the threshold value and the overall ozone median. In a
box-whisker plot are some information hidden because its shows only the
percentiles. Therefore, a jitters plot is added.

```{r statistical_parameters}
#monthly median for temperature, ozone, solar and wind
airquality_mutated |>
#calculate the median for the ozone concentraion  
  summarise(median.temp = median(Temp, na.rm = TRUE),
            median.wind = median(Wind, na.rm = TRUE),
            median.ozone = median(Ozone, na.rm = TRUE),
            Min.ozone = min(Ozone, na.rm = TRUE),
            Q1.ozone = quantile(Ozone, 0.25, na.rm = TRUE),
            Q2.ozone = quantile(Ozone, 0.5, na.rm = TRUE),
            Q3.ozone = quantile(Ozone, 0.75, na.rm = TRUE),
            Max.ozone = max(Ozone, na.rm = TRUE),
            IQR.ozone = IQR(Ozone, na.rm = TRUE),
            Span = max(Ozone, na.rm = TRUE) - min(Ozone, na.rm = TRUE),
            Average.ozone = mean(Ozone, na.rm = TRUE))

#calculate the overall median for the ozone concentration
median(airquality_mutated$Ozone, na.rm = TRUE)
```

```{r scattering_ozone_per_month_boxplot}
# use ggplot to visualise the distribution of ozone for each month
airquality_mutated |>
ggplot(aes(x = factor(Month), y = Ozone, na.rm = TRUE)) +
# Boxplot with an individual setup in transparency, size and width
# red colour, individual shape and size for outliers
  geom_boxplot(fill = "skyblue", alpha = 0.5, size = 0.5, width = 0.5,
               outlier.color = "red", outlier.shape = 17, outlier.size = 2) +
# add whiskers  
  stat_boxplot(geom = "errorbar") +
# make the values transparent and force the values with width statemant in a colomn
  geom_jitter(width = 0, alpha = 0.1) +
# create and add a fine dotdashed line for the threshold values for Switzerland as a reference
  geom_hline(yintercept = 60, color = "darkmagenta", size = 0.3, linetype = "dotdash") +
# create and add a dotted line for the median for the ozone concentration 
  geom_hline(yintercept =  median(airquality_mutated$Ozone, na.rm = TRUE), 
             color = "royalblue", size = 0.3, linetype = "dotdash") +
# add label for the Threshold 
  ggplot2::annotate("text", x =  0.5 , y = 170, hjust = 0, 
           label = "Threshold value [60 ppb]", color = "darkmagenta") +
# add label for the median
  ggplot2::annotate("text", x = 0.5 , y =  160, hjust = 0, 
           label = "Overall median [31.5 ppm]", color = "royalblue") +
# add label for the outliers
  ggplot2::annotate("text", x = 0.5 , y =  150, hjust = 0, 
           label = "Outliers", color = "red") +
# label the graphic and axes
  labs(title = "Ozone concentration per month",
       subtitle = "At Roosevelt Island, NYC [Average concentration between 1pm and 3pm]",
       x = "Month", y = "Ozone concentration [ppb]",
       caption = "AGDS Report Exercise 2 (Chapter 4)") +
# chose a background for the graoph 
  theme_bw() +
  theme(plot.title = element_text(size = 15, face = "bold")) +
# add panel boarder  
  theme(panel.border = element_rect(colour = "black", fill = NA, linewidth = 1)) +
  theme(plot.margin = margin(0.3, 1, 0.3, 0.3, "cm"),
  panel.background = element_rect(fill = "white"),
  plot.background = element_rect(fill = "grey90",colour = "black")) 
```

With the box-whisker-plot we know more about the distribution. But we do
not know much how often a value occurs. For this information we create a
bar plot. But we are not only interested in the blank number. We want also
information about the distribution. That is why we create a density plot.
We add again the threshold and the overall median for a easier
interpretation.

The plot shows us that the data have a big span. But the core of the data
(area with a high density) has an acceptable span. But the graph shows us
also that there are many days when the ozone concentration is to high.

```{r}
airquality_mutated|>
ggplot(aes(x = Ozone, group = Month, fill = Month)) +
# add the   geom_density and create an individual setup
    geom_density(adjust = 1.5, alpha = 0.4) +
# add title and subtitle and label the axes  
    labs(x = "Ozon [ppb]", y = "Density", 
    title = "Density of the ozone concentration",
    subtitle = "At Roosevelt Island, NYC [Average concentration between 1pm and 3pm]",
    caption = "AGDS Report Exercise 2 (Chapter 4)") +
# add a vline with an individual setup  
    geom_vline(xintercept = 60, size = 0.3, 
               linetype = "dotdash", color = "darkmagenta") +
    geom_vline(xintercept = median(airquality_mutated$Ozone, na.rm = TRUE), 
               size = 0.3, linetype = "dotdash", color = "royalblue") +
    ggplot2::annotate("text", x = 115 , y =  0.0218, hjust = 0, 
           label = "Overall median [31.5 ppb]", color = "royalblue") +
    ggplot2::annotate("text", x = 115 , y =  0.0235, hjust = 0, 
           label = "Threshold value [60 ppb]", color = "darkmagenta") +
# chose a background and add a panel boarder  
    theme_bw() +
    theme(plot.title = element_text(size = 15, face = "bold")) +
    theme(panel.border = element_rect(colour = "black", fill = NA, linewidth = 1)) +
    theme( legend.background = element_rect( fill = "lightblue", 
                size = 0.5, linetype = "solid", colour = "black")) +
    theme(plot.margin = margin(0.3, 0.3, 0.3, 0.3, "cm"),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "grey90",colour = "black"))   
```

But we detect many missing values. For a stringent analysis we need to know
which values are missing. Are there a systematic error in the instrument?
Or simple forgot someone to write down the measurement? For us is only
interesting weather this has a influence on our evaluation. For that we
create a plot who shows us which values are missing. after that we can
decide what is the best procedure to handle this.

```{r}
# create a bar plot and mark the missing values with -1
airquality_mutated |>
  ggplot(aes(x = Date, y = Ozone, group = Month, color = Month)) +
# create a geom bar  
  geom_bar(stat = "identity") +
# make a geom with points  
  geom_point(size = 1.5) +
# make a geom with the missing values. change NA to -1  
  geom_point(data = airquality_mutated |>
  mutate_all( ~replace_na(.,-1)) |>
  dplyr::filter(`Ozone` == -1) , size = 1.5, color = "red") +
  labs(x = "Month", y = "Ozon [ppb]", 
  title = "Daily ozone concentration",
  subtitle = "At Roosevelt Island, NYC [daily average concentration between 1pm and 3pm]",
  caption = "AGDS Report Exercise 2 (Chapter 4)") +
# chose a background and add a panel boarder  
  theme_bw() +
  theme(plot.title = element_text(size = 15, face = "bold")) +
  theme(panel.border = element_rect(colour = "black", fill = NA, linewidth = 1)) +
  theme( legend.background = element_rect( fill = "lightblue", 
                size = 0.5, linetype = "solid", colour = "black")) +
  theme(plot.margin = margin(0.3, 0.3, 0.3, 0.3, "cm"),
  panel.background = element_rect(fill = "white"),
  plot.background = element_rect(fill = "grey90",colour = "black"))
```

### Correlation

First, we want to know whether the variables of the hypothesis are
promisingly. For this purpose we create a correlation matrix. The graphic
shows us a high correlation between ozone concentration vs. temperature and
ozone concentration vs. wind. There is also a correlation between ozone
concentration and solar radiation but not so strong. Nevertheless, the
chosen variables are promisingly and we can work straight forward.

```{r correlation_plot}
# correlation of the variables in the data frame
airquality_mutated |>
  select( Ozone, Wind, Temp, Solar.R) |>
# chose the right method  
  cor(use = "pairwise") |>
# plot lower triangle with the correlation coefficients
  ggcorrplot(hc.order = TRUE,
           type = "lower", lab = TRUE) +
# label the graphic
  labs(title = "Correlation overview") +
# change the size of the title  
  theme(plot.title = element_text(size = 15, face = "bold")) +
  theme(plot.margin = margin(0.3, 0.3, 0.3, 0.3, "cm"),
  panel.background = element_rect(fill = "white"),
  plot.background = element_rect(fill = "grey90",colour = "black"))   
```

Simple linear regression models are constructed to answer the research
question. This allows the relationship between the variables to be
quantified. The first model is ozone vs. temperature. After that follows
the models 2 (ozone vs. wind) and model 3 (ozone vs. solar radiation).

### Regression models

#### Simple linear regression

A simple linear regression model:

```{r linear_regression_model_ozone_temperature}
#calculate a simple linear regression: ozone vs. temperature
model.fit.ozone.temp <- 
  lm(airquality_mutated$Ozone ~ airquality_mutated$Temp,
  airquality_mutated = airquality_mutated)
summary(model.fit.ozone.temp)

#calculate a simple linear regression: ozone vs. wind
model.fit.ozone.wind <- 
  lm(airquality_mutated$Ozone ~ airquality_mutated$Wind, 
  airquality_mutated = airquality_mutated)
summary(model.fit.ozone.wind)

#calculate a simple linear regression: ozone vs. solar radiation
model.fit.ozone.solar <- 
  lm(airquality_mutated$Ozone ~ airquality_mutated$Solar.R, 
  airquality_mutated = airquality_mutated)
summary(model.fit.ozone.solar)
```

For a better interpretation the model can be visualized:

```{r linear_regression_model_ozone_time}
P1 <- airquality_mutated |>
  ggplot(aes(x = Day, y = Ozone, color = Month)) +
  geom_point(alpha = 0.5) +
  scale_y_continuous(limits = c(0, 250)) +
#use smooth for a linear regression, se for standard error  
  geom_smooth(formula = y ~ x, method = "lm", se = FALSE) +
  stat_poly_eq(use_label(c("eq", "R2"))) +
  geom_hline(yintercept = 60, linetype = "dotdash", 
             size = 0.3, color = "darkmagenta") +
#lab the axes and giv the graphic a title  
  labs(title = "Ozone vs. Time",
       x = "Time [Day]", y = "Ozone [ppb]",
       caption = "AGDS Report Exercise 2 (Chapter 4)") +
  theme_bw() +
  theme(plot.title = element_text(size = 15, face = "bold")) +
  theme(panel.border = element_rect(colour = "black", 
       fill = NA, linewidth = 1)) +
  theme( legend.background = element_rect( fill = "lightblue", 
       size = 0.5, linetype = "solid", colour = "black")) +
  theme(plot.margin = margin(0.3, 0.3, 0.3, 0.3, "cm"),
  panel.background = element_rect(fill = "white"),
  plot.background = element_rect(fill = "grey90",colour = "black"))   
```

```{r visualize_linear_regression_model_ozone_temperature}
P2 <- airquality_mutated |>
  ggplot(aes(x = Temp, y = Ozone, color = Month)) +
  geom_point(alpha = 0.5) +
  scale_y_continuous(limits = c(0, 250)) +
#use smooth for a linear regression, se for standard error  
  geom_smooth(formula = y ~ x, method = "lm", se = FALSE) +
  stat_poly_eq(use_label(c("eq", "R2"))) +
  geom_hline(yintercept = 60, linetype = "dotdash", 
          size = 0.3, color = "darkmagenta") +
#lab the axes and giv the graphic a title  
  labs(title = "Ozone vs. Temperature", 
          x = "Temperature [Kelvin]", y = "Ozone [ppb]",
       caption = "AGDS Report Exercise 2 (Chapter 4)") +
  theme_bw() +
  theme(plot.title = element_text(size = 15, face = "bold")) +
  theme(panel.border = element_rect(colour = "black", 
          fill = NA, linewidth = 1)) +
  theme( legend.background = element_rect( fill = "lightblue", 
          size = 0.5, linetype = "solid", colour = "black")) +
  theme(plot.margin = margin(0.3, 0.3, 0.3, 0.3, "cm"),
  panel.background = element_rect(fill = "white"),
  plot.background = element_rect(fill = "grey90",colour = "black"))   
```

```{r visualize_linear_regression_model_ozone_wind}
P3 <- airquality_mutated |>
  ggplot(aes(x = Wind, y = Ozone, color = Month)) +
  geom_point(alpha = 0.5) +
  scale_y_continuous(limits = c(0, 250)) +
#use smooth for a linear regression, se for standard error  
  geom_smooth(formula = y ~ x, method = "lm", se = FALSE) +
  stat_poly_eq(use_label(c("eq", "R2"))) +
  geom_hline(yintercept = 60, linetype = "dotdash", 
        size = 0.3, color = "darkmagenta") +
#lab the axes and giv the graphic a title  
  labs(title = "Ozone vs. Wind",
       x = "Wind [m/s]", y = "Ozone [ppb]",
       caption = "AGDS Report Exercise 2 (Chapter 4)") +
  theme_bw() +
  theme(plot.title = element_text(size = 15, face = "bold")) +  
  theme(panel.border = element_rect(colour = "black", 
        fill = NA, linewidth = 1)) +
  theme( legend.background = element_rect( fill = "lightblue", 
        size = 0.5, linetype = "solid", colour = "black")) +
  theme(plot.margin = margin(0.3, 0.3, 0.3, 0.3, "cm"),
  panel.background = element_rect(fill = "white"),
  plot.background = element_rect(fill = "grey90",colour = "black")) 
```

```{r visualize_regression_model_solar.r}
P4 <- airquality_mutated |>
  ggplot(aes(x = Solar.R, y = Ozone, color = Month)) +
  geom_point(alpha = 0.5) +
  scale_y_continuous(limits = c(0, 250)) +
#use smooth for a linear regression, se for standard error  
  geom_smooth(formula = y ~ x, method = "lm", se = FALSE) +
  stat_poly_eq(use_label(c("eq", "R2"))) +
  geom_hline(yintercept = 60, linetype = "dotdash", 
        size = 0.3, color = "darkmagenta") +
#lab the axes and giv the graphic a title  
  labs(title = "Ozone vs. solar irradiation", 
       subtitle = "Linear Regression Model",
       x = "solar irradiation [J/m^2]", y = "Ozone [ppb]",
       caption = "AGDS Report Exercise 2 (Chapter 4)") +
  theme_bw() +
  theme(plot.title = element_text(size = 15, face = "bold")) +  
  theme(panel.border = element_rect(colour = "black", 
        fill = NA, linewidth = 1)) +
  theme( legend.background = element_rect( fill = "lightblue", 
        size = 0.5, linetype = "solid", colour = "black")) +
  theme(plot.margin = margin(0.3, 0.3, 0.3, 0.3, "cm"),
  panel.background = element_rect(fill = "white"),
  plot.background = element_rect(fill = "grey90",colour = "black")) 
```

Overview simple linear regression models:

```{r patch_all_models_together}
# plot the graphs in a grid
plot_grid(P2, P3, P4, NULL, labels = c("A","B","C"))
```

### Results and Discussion

-   We don't nothing about the missing values. are there no measurements?
    instruments? Sensitivity?

-   Not the same place

-   much of fossil fuels

-   different wind scheme

### Bibliography

Brönnimann Stefan (2013): Ozon in der Atmosphäre. Bern, Haupt Verlag. DOI:
10.480/GB2013.03
